apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: agentpools.neuronetes.io
  annotations:
    controller-gen.kubebuilder.io/version: v0.11.0
spec:
  group: neuronetes.io
  names:
    kind: AgentPool
    listKind: AgentPoolList
    plural: agentpools
    shortNames:
    - ap
    singular: agentpool
  scope: Namespaced
  versions:
  - name: v1alpha1
    schema:
      openAPIV3Schema:
        description: AgentPool is the Schema for the agentpools API
        properties:
          apiVersion:
            description: 'APIVersion defines the versioned schema of this representation of an object.'
            type: string
          kind:
            description: 'Kind is a string value representing the REST resource this object represents.'
            type: string
          metadata:
            type: object
          spec:
            description: AgentPoolSpec defines the desired state of AgentPool
            properties:
              agentClassRef:
                description: AgentClassRef references the AgentClass to use
                properties:
                  name:
                    description: Name of the referenced AgentClass
                    type: string
                required:
                - name
                type: object
              minReplicas:
                description: MinReplicas is the minimum number of replicas
                format: int32
                minimum: 0
                type: integer
              maxReplicas:
                description: MaxReplicas is the maximum number of replicas
                format: int32
                minimum: 1
                type: integer
              prewarmPercent:
                description: PrewarmPercent is the percentage of maxReplicas to keep warm
                format: int32
                minimum: 0
                maximum: 100
                type: integer
              tokensPerSecondBudget:
                description: TokensPerSecondBudget is the total tokens/sec budget for the pool
                format: int32
                type: integer
              migProfile:
                description: MIGProfile specifies the MIG profile for GPU partitioning
                type: string
              autoscaling:
                description: Autoscaling defines autoscaling configuration
                properties:
                  metrics:
                    description: Metrics to use for autoscaling decisions
                    items:
                      properties:
                        type:
                          description: Type of metric
                          enum:
                          - tokens-in-queue
                          - tokens-per-second
                          - ttft-p95
                          - ttft-p99
                          - concurrent-sessions
                          - queue-depth
                          - cost-per-token
                          type: string
                        target:
                          description: Target value for the metric
                          type: string
                        averagingWindow:
                          description: AveragingWindow for the metric
                          type: string
                      required:
                      - type
                      - target
                      type: object
                    type: array
                  behavior:
                    description: Behavior configures scaling behavior
                    properties:
                      scaleUp:
                        description: ScaleUp configuration
                        properties:
                          stabilizationWindow:
                            type: string
                          maxChangePercent:
                            format: int32
                            type: integer
                          maxChangeAbsolute:
                            format: int32
                            type: integer
                          periodSeconds:
                            format: int32
                            type: integer
                        type: object
                      scaleDown:
                        description: ScaleDown configuration
                        properties:
                          stabilizationWindow:
                            type: string
                          maxChangePercent:
                            format: int32
                            type: integer
                          maxChangeAbsolute:
                            format: int32
                            type: integer
                          periodSeconds:
                            format: int32
                            type: integer
                        type: object
                    type: object
                  cooldownPeriod:
                    description: CooldownPeriod between scaling events
                    type: string
                type: object
              gpuRequirements:
                description: GPURequirements specifies GPU requirements per replica
                properties:
                  count:
                    description: Count of GPUs required
                    format: int32
                    minimum: 1
                    type: integer
                  memory:
                    description: Memory required per GPU
                    type: string
                  type:
                    description: Type of GPU (e.g., A100, H100)
                    type: string
                  topology:
                    description: Topology requirements for multi-GPU
                    properties:
                      locality:
                        enum:
                        - same-node
                        - same-socket
                        - nvlink
                        - any
                        type: string
                      minBandwidth:
                        type: string
                    type: object
                required:
                - count
                type: object
              sessionAffinity:
                description: SessionAffinity configures sticky routing
                properties:
                  enabled:
                    description: Enabled turns on session affinity
                    type: boolean
                  keyHeader:
                    description: KeyHeader is the header containing session key
                    type: string
                  ttl:
                    description: TTL for session affinity
                    type: string
                  type:
                    description: Type of affinity key
                    enum:
                    - conversation-id
                    - user-id
                    - custom
                    type: string
                required:
                - enabled
                type: object
              scheduling:
                description: Scheduling configures pod scheduling
                properties:
                  priority:
                    description: Priority for scheduling
                    format: int32
                    type: integer
                  costOptimization:
                    description: CostOptimization settings
                    properties:
                      enabled:
                        type: boolean
                      maxCostPerHour:
                        type: string
                      spotEnabled:
                        type: boolean
                      sloHeadroomMs:
                        format: int32
                        type: integer
                      fallbackModel:
                        type: string
                    type: object
                  dataLocality:
                    description: DataLocality for co-scheduling with data
                    properties:
                      vectorStoreAffinity:
                        items:
                          type: string
                        type: array
                      cacheAffinity:
                        items:
                          type: string
                        type: array
                    type: object
                  nodeSelector:
                    additionalProperties:
                      type: string
                    type: object
                type: object
            required:
            - agentClassRef
            - minReplicas
            - maxReplicas
            type: object
          status:
            description: AgentPoolStatus defines the observed state of AgentPool
            properties:
              conditions:
                items:
                  properties:
                    lastTransitionTime:
                      format: date-time
                      type: string
                    message:
                      type: string
                    reason:
                      type: string
                    status:
                      type: string
                    type:
                      type: string
                  required:
                  - lastTransitionTime
                  - status
                  - type
                  type: object
                type: array
              phase:
                enum:
                - Pending
                - Scaling
                - Ready
                - Degraded
                - Failed
                type: string
              replicas:
                format: int32
                type: integer
              readyReplicas:
                format: int32
                type: integer
              warmReplicas:
                format: int32
                type: integer
              currentTokensPerSecond:
                format: int32
                type: integer
              currentCostPerHour:
                type: string
              activeSessions:
                format: int32
                type: integer
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
      scale:
        specReplicasPath: .spec.maxReplicas
        statusReplicasPath: .status.replicas
    additionalPrinterColumns:
    - name: Class
      type: string
      jsonPath: .spec.agentClassRef.name
    - name: Min
      type: integer
      jsonPath: .spec.minReplicas
    - name: Max
      type: integer
      jsonPath: .spec.maxReplicas
    - name: Ready
      type: integer
      jsonPath: .status.readyReplicas
    - name: Phase
      type: string
      jsonPath: .status.phase
    - name: Age
      type: date
      jsonPath: .metadata.creationTimestamp
